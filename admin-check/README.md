# 管理員權限檢查與提權模板（參數兼容版）  

## 一、腳本概述  

### 1.1 腳本名稱  

管理員權限檢查與提權模板 (參數兼容版)  

### 1.2 功能說明  

本腳本實現安全的權限提升機制，同時保持原始命令行參數的完整性。主要特點：  

- 智能區分提權標記(-elevated)與用戶參數  
- 自動參數重組技術，確保提權前後參數一致性  
- 完整錯誤代碼處理體系  

## 二、執行流程  

### 2.1 階段1：初始啟動  

1. **參數解析器檢查**：檢查 %1 是否為 "-elevated"  

   - 是：移除提權標記，跳過提權檢查 (已進入提權模式)  
   - 否：繼續權限驗證  

2. **權限驗證**：通過 fltmc 命令驗證權限  

   - 成功：直接進入主程式 (當前已是管理員)  
   - 失敗：觸發提權流程  

### 2.2 階段2：提權過程  

3. **通過PowerShell重新啟動腳本**：  

   - 自動添加 "-elevated" 作為第一參數  
   - 保留原始參數 (%*) 接在後方  
   - 使用$p及_Wait、_PassThru捕獲新進程的ExitCode作為%ERRORLEVEL%值返回  

4. **提權結果處理**：  

   - 成功：原始實例退出，新實例以管理員身份運行  
   - 失敗：根據錯誤碼精確報錯  

### 2.3 階段3：提權後執行  

5. **參數恢復**：  

   - 使用 shift /1 移除 "-elevated"  
   - 原始參數位置恢復 (%1=%1_原始, %2=%2_原始...)  

6. **執行主程式邏輯**  


## 三、參數傳遞示例  

- 用戶輸入：`test.bat file.txt -force`  
- 提權實例：`test.bat -elevated file.txt -force`  
- 最終參數：`file.txt -force` (主程式所見)  


## 四、系統需求  

- Windows XP 或更新版本  
- PowerShell 2.0 或更新版本（用於提權功能）  


## 五、安全性注意  

- 需要提權時會顯示 UAC 確認視窗  
- 提權後的代碼需特別注意安全性風險  


## 六、返回代碼說明  

| 錯誤代碼 | 說明 |  
|----------|------|  
| 0 | 成功，提權請求已發送 |  
| 5 | ERROR_ACCESS_DENIED，群組原則限制禁止提權 |  
| 740 | ERROR_ELEVATION_REQUIRED，執行需要管理員權限的Powershell命令但未獲得UAC授權 |  
| 1223 | ERROR_CANCELLED，使用者點擊UAC的「否」按鈕 |  
| 1603 | INSTALL_FAILED，提權後的Powershell執行安裝程序時出現權限不足或安裝程式的版本衝突 |  


## 七、腳本代碼  

腳本的完整實現可查看倉庫內的範例文件：  
[bat檔判斷系統管理員及提權正確操作指令.txt](https://github.com/你的用戶名/2025-batch-file-q_a/blob/main/admin-check/bat檔判斷系統管理員及提權正確操作指令.txt)  